<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Palettenschein Generator</title>
  <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <!-- Microsoft Graph SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@azure/msal-browser@2.38.3/lib/msal-browser.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input, select, button, canvas { margin: 8px 0; width: 100%; padding: 8px; }
    canvas { background: #fff; border: 1px solid #ccc; height: 150px; }
    #download-buttons { margin-top: 20px; }
    #onedrive-section { margin-top: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background-color: #f9f9f9; }
    .auth-status { font-weight: bold; color: #0078d4; }
    .success { color: #107c10; }
    .error { color: #d13438; }
    .warning { color: #ff8c00; }
    .onedrive-button { background-color: #0078d4; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
    .onedrive-button:hover { background-color: #106ebe; }
    .onedrive-button:disabled { background-color: #ccc; cursor: not-allowed; }
    .info-box { background-color: #e7f3ff; border: 1px solid #0078d4; border-radius: 5px; padding: 10px; margin: 10px 0; }
  </style>
</head>
<body>
  <h2>Palettenschein Generator</h2>

  <form id="main-form">
    <label for="company">Spedition wÃ¤hlen</label>
    <select id="company" onchange="handleCompanyChange()" required>
      <option value="DHL">DHL</option>
      <option value="Intern">Intern</option>
      <option value="GLS">GLS</option>
    </select>

    <label>Nr</label>
    <input type="text" id="nr" required readonly />

    <label>Datum</label>
    <input type="date" id="datum" required />

    <label>Spedition</label>
    <input type="text" id="spedition" readonly />

    <label>EmpfÃ¤nger</label>
    <input type="text" id="empfaenger" />

    <label>Lieferant</label>
    <input type="text" id="lieferant" />

    <label>WA/WE</label>
    <select id="wawe">
      <option value="WA">WA</option>
      <option value="WE">WE</option>
    </select>

    <label>Europaletten</label>
    <input type="number" id="euro" />

    <label>Einwegpaletten</label>
    <input type="number" id="einweg" />

    <label>Hinweis</label>
    <input type="text" id="hinweis" />

    <label>Unterschrift Fahrer</label>
    <canvas id="sign-fahrer"></canvas>

    <label>Unterschrift d-log</label>
    <canvas id="sign-dlog"></canvas>

    <button type="submit">âœ… Speichern & PDF + CSV</button>
  </form>

  <div id="download-buttons" style="display:none;">
    <button id="download-pdf">â¬‡ï¸ PDF Herunterladen</button>
    <button id="download-csv">â¬‡ï¸ CSV Herunterladen</button>
  </div>

  <div id="onedrive-section">
    <h3>ğŸ“ OneDrive Synchronisation</h3>
    <div class="info-box">
      <strong>â„¹ï¸ Hinweis:</strong> OneDrive-Integration erfordert Ihre Zustimmung zum Dateizugriff. 
      Sie werden beim ersten Login nach der Berechtigung gefragt.
    </div>
    <div id="auth-status" class="auth-status">Nicht angemeldet</div>
    <button id="login-button" class="onedrive-button">ğŸ” Mit OneDrive anmelden</button>
    <div style="margin: 10px 0; display:none;" id="auto-upload-option">
      <label>
        <input type="checkbox" id="auto-upload-checkbox"> 
        Automatisch zu OneDrive hochladen nach PDF-Erstellung
      </label>
    </div>
    <button id="upload-button" class="onedrive-button" style="display:none;">â˜ï¸ PDF zu OneDrive hochladen</button>
    <button id="upload-csv-button" class="onedrive-button" style="display:none;">ğŸ“Š CSV zu OneDrive hochladen</button>
    <button id="logout-button" class="onedrive-button" style="display:none;">ğŸšª Abmelden</button>
    <div id="upload-status"></div>
  </div>

  <script>
    // ------------------ OneDrive Microsoft Graph API é›†æˆ ------------------
    
    // Microsoft Graph API é…ç½®
    const msalConfig = {
      auth: {
        clientId: "e536f270-532e-4a73-a763-51116df31fc5",
        authority: "https://login.microsoftonline.com/common",
        redirectUri: "https://555-wheat-beta.vercel.app/"
      },
      cache: {
        cacheLocation: "localStorage",
        storeAuthStateInCookie: false
      }
    };

    // ç™»å½•æ—¶è·å–æ‰€æœ‰å¿…è¦æƒé™ï¼Œé¿å…åç»­äº¤äº’å¼æƒé™è¯·æ±‚
    const loginRequest = {
      scopes: ["User.Read", "Files.ReadWrite"], // ä¸€æ¬¡æ€§è·å–æ‰€æœ‰éœ€è¦çš„æƒé™
      prompt: "consent" // å¼ºåˆ¶æ˜¾ç¤ºæƒé™åŒæ„ç•Œé¢ï¼Œç¡®ä¿ç”¨æˆ·æ˜ç¡®æˆäºˆæ‰€æœ‰æƒé™
    };

    // æ–‡ä»¶è®¿é—®æƒé™é…ç½®ï¼ˆä¸ç™»å½•æƒé™ä¿æŒä¸€è‡´ï¼‰
    const fileAccessRequest = {
      scopes: ["User.Read", "Files.ReadWrite"]  // åªä½¿ç”¨å§”æ‰˜æƒé™ï¼Œé¿å… .All åç¼€
    };

    let msalInstance;
    let account = null;
    let isInitializing = false;
    let initializationPromise = null;

    // åˆå§‹åŒ– MSAL
    async function initializeMSAL() {
      if (isInitializing || msalInstance) {
        return initializationPromise;
      }
      
      isInitializing = true;
      initializationPromise = (async () => {
        try {
          console.log("å¼€å§‹åˆå§‹åŒ– MSAL...");
          msalInstance = new msal.PublicClientApplication(msalConfig);
          await msalInstance.initialize();
          console.log("MSAL åˆå§‹åŒ–å®Œæˆ");
          
          // å¤„ç†é‡å®šå‘å“åº”
          const response = await msalInstance.handleRedirectPromise();
          if (response) {
            account = response.account;
            // è®¾ç½®ä¸ºæ´»åŠ¨è´¦æˆ·
            msalInstance.setActiveAccount(account);
            updateAuthStatus(true);
            // æ˜¾ç¤ºè·å¾—çš„æƒé™èŒƒå›´
            const grantedScopes = response.scopes.join(", ");
            showUploadStatus(`âœ… OneDrive-Anmeldung erfolgreich! Erteilte Berechtigungen: ${grantedScopes}`, "success");
            console.log("ä»é‡å®šå‘å“åº”ä¸­è·å–åˆ°è´¦æˆ·:", account.username);
            console.log("è·å¾—çš„æƒé™èŒƒå›´:", response.scopes);
          } else {
            // æ£€æŸ¥æ˜¯å¦å·²ç»ç™»å½•
            const accounts = msalInstance.getAllAccounts();
            if (accounts.length > 0) {
              account = accounts[0];
              // è®¾ç½®ä¸ºæ´»åŠ¨è´¦æˆ·
              msalInstance.setActiveAccount(account);
              updateAuthStatus(true);
              console.log("ä»æœ¬åœ°ç¼“å­˜ä¸­è·å–åˆ°è´¦æˆ·:", account.username);
            }
          }
          
          // åˆå§‹åŒ–å®Œæˆåç»‘å®šäº‹ä»¶ç›‘å¬å™¨
          bindEventListeners();
          
        } catch (error) {
          console.error("MSAL initialization error:", error);
          showUploadStatus("âŒ MSAL åˆå§‹åŒ–å¤±è´¥: " + error.message, "error");
          throw error;
        } finally {
          isInitializing = false;
        }
      })();
      
      return initializationPromise;
    }

    // æ›´æ–°è®¤è¯çŠ¶æ€æ˜¾ç¤º
    function updateAuthStatus(isLoggedIn) {
      const authStatus = document.getElementById("auth-status");
      const loginButton = document.getElementById("login-button");
      const uploadButton = document.getElementById("upload-button");
      const uploadCSVButton = document.getElementById("upload-csv-button");
      const logoutButton = document.getElementById("logout-button");
      const autoUploadOption = document.getElementById("auto-upload-option");

      if (isLoggedIn && account) {
        authStatus.textContent = `Angemeldet als: ${account.username}`;
        authStatus.className = "auth-status success";
        loginButton.style.display = "none";
        uploadButton.style.display = "inline-block";
        uploadCSVButton.style.display = "inline-block";
        logoutButton.style.display = "inline-block";
        autoUploadOption.style.display = "block";
      } else {
        authStatus.textContent = "Nicht angemeldet";
        authStatus.className = "auth-status";
        loginButton.style.display = "inline-block";
        uploadButton.style.display = "none";
        uploadCSVButton.style.display = "none";
        logoutButton.style.display = "none";
        autoUploadOption.style.display = "none";
      }
    }

    // OneDrive ç™»å½• - åªè¯·æ±‚åŸºæœ¬æƒé™
    async function loginToOneDrive() {
      try {
        showUploadStatus("â³ Anmeldung lÃ¤uft...", "");
        
        // ç¡®ä¿MSALå·²åˆå§‹åŒ–
        if (!msalInstance) {
          showUploadStatus("â³ Initialisierung lÃ¤uft...", "");
          await initializeMSAL();
        }
        
        if (!msalInstance) {
          throw new Error("MSAL åˆå§‹åŒ–å¤±è´¥");
        }
        
        console.log("å¼€å§‹ç™»å½•è¿‡ç¨‹ï¼Œè·å–OneDriveæ–‡ä»¶è®¿é—®æƒé™...");
        console.log("è¯·æ±‚çš„æƒé™èŒƒå›´:", loginRequest.scopes);
        console.log("å¼ºåˆ¶æƒé™ç¡®è®¤:", loginRequest.prompt);
        showUploadStatus("ğŸ”„ Weiterleitung zur Anmeldung mit OneDrive-Berechtigung...", "warning");
        await msalInstance.loginRedirect(loginRequest);
        // æ³¨æ„ï¼šé‡å®šå‘åï¼Œé¡µé¢ä¼šé‡æ–°åŠ è½½ï¼Œç™»å½•æˆåŠŸçš„å¤„ç†ä¼šåœ¨ handleRedirectPromise ä¸­è¿›è¡Œ
        
      } catch (error) {
        console.error("Login error:", error);
        showUploadStatus("âŒ Anmeldung fehlgeschlagen: " + error.message, "error");
      }
    }

    // OneDrive æ³¨é”€
    async function logoutFromOneDrive() {
      try {
        showUploadStatus("â³ Abmeldung lÃ¤uft...", "");
        
        if (!msalInstance) {
          throw new Error("MSAL nicht initialisiert");
        }
        
        const logoutRequest = {
          account: account
        };
        showUploadStatus("ğŸ”„ Weiterleitung zur Abmeldung...", "warning");
        await msalInstance.logoutRedirect(logoutRequest);
        // æ³¨æ„ï¼šé‡å®šå‘åï¼Œé¡µé¢ä¼šé‡æ–°åŠ è½½
        
      } catch (error) {
        console.error("Logout error:", error);
        // å³ä½¿æ³¨é”€å¤±è´¥ï¼Œä¹Ÿæ¸…é™¤æœ¬åœ°çŠ¶æ€
        account = null;
        updateAuthStatus(false);
        showUploadStatus("âš ï¸ Abmeldung mit Fehlern, lokale Anmeldung wurde trotzdem gelÃ¶scht.", "error");
      }
    }

    // é™é»˜è·å–æ–‡ä»¶è®¿é—®æƒé™ï¼ˆä¸è¿›è¡Œäº¤äº’å¼è·å–ï¼‰
    async function getFileAccessToken() {
      if (!account) {
        throw new Error("Kein Konto gefunden. Bitte melden Sie sich zuerst an.");
      }

      if (!msalInstance) {
        throw new Error("MSAL nicht initialisiert");
      }

      try {
        console.log("å°è¯•é™é»˜è·å–æ–‡ä»¶è®¿é—®æƒé™...");
        console.log("ä½¿ç”¨è´¦æˆ·:", account.username);
        
        // è®¾ç½®æ´»åŠ¨è´¦æˆ·ï¼ˆæ¨èåšæ³•ï¼‰
        msalInstance.setActiveAccount(account);
        
        // åœ¨è¯·æ±‚ä¸­æ˜ç¡®æŒ‡å®šè´¦æˆ·
        const tokenRequest = {
          ...fileAccessRequest,
          account: account
        };
        
        const response = await msalInstance.acquireTokenSilent(tokenRequest);
        console.log("é™é»˜è·å–æ–‡ä»¶è®¿é—®ä»¤ç‰ŒæˆåŠŸ");
        return response.accessToken;
      } catch (error) {
        console.error("é™é»˜è·å–æƒé™å¤±è´¥:", error);
        console.error("é”™è¯¯è¯¦æƒ…:", error.errorCode, error.errorMessage);
        
        // æ ¹æ®é”™è¯¯ç±»å‹æä¾›æ›´å…·ä½“çš„æç¤º
        if (error.errorCode === "consent_required") {
          throw new Error("OneDrive-Berechtigung fehlt. Bitte melden Sie sich ab und erneut an, um die erforderlichen Berechtigungen zu erteilen.");
        } else if (error.errorCode === "interaction_required") {
          throw new Error("Sitzung abgelaufen. Bitte melden Sie sich erneut an.");
        } else {
          throw new Error(`Berechtigungsfehler: ${error.errorMessage || error.message}. Bitte melden Sie sich ab und erneut an.`);
        }
      }
    }

    // ä¸Šä¼ CSVæ–‡ä»¶åˆ°OneDrive
    async function uploadCSVToOneDrive() {
      if (!account) {
        showUploadStatus("âŒ Bitte melden Sie sich zuerst bei OneDrive an!", "error");
        return false;
      }

      if (!msalInstance) {
        showUploadStatus("âŒ OneDrive-Service nicht verfÃ¼gbar. Versuchen Sie, die Seite neu zu laden.", "error");
        return false;
      }

      if (!csvContent || csvContent.trim() === "Nr,Datum,Spedition,Empfaenger,Lieferant,WA_WE,Europaletten,Einwegpaletten,Hinweis") {
        showUploadStatus("âŒ Keine CSV-Daten vorhanden. Bitte generieren Sie zuerst ein PDF!", "error");
        return false;
      }

      try {
        showUploadStatus("â³ Berechtigung fÃ¼r CSV-Upload wird Ã¼berprÃ¼ft...", "");
        
        // ç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„å”¯ä¸€CSVæ–‡ä»¶åï¼Œé¿å…è¦†ç›–
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
        const csvFileName = `PalettenscheinData-${timestamp}.csv`;
        console.log(`å¼€å§‹ä¸Šä¼ CSVæ–‡ä»¶: ${csvFileName}`);
        
        const accessToken = await getFileAccessToken();
        
        showUploadStatus("â³ Lade CSV zu OneDrive hoch...", "");
        console.log("CSVæ–‡ä»¶è®¿é—®æƒé™è·å–æˆåŠŸï¼Œå¼€å§‹ä¸Šä¼ ");
        
        // åˆ›å»ºæ–‡ä»¶å¤¹ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        const folderName = "Palettenscheine";
        await createOneDriveFolder(accessToken, folderName);
        
        // åˆ›å»ºCSV Blob
        const csvBlob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        
        // ä¸Šä¼ CSVæ–‡ä»¶åˆ°æŒ‡å®šæ–‡ä»¶å¤¹
        const uploadUrl = `https://graph.microsoft.com/v1.0/me/drive/root:/${folderName}/${csvFileName}:/content`;
        
        console.log(`CSVä¸Šä¼ åˆ°: ${uploadUrl}`);
        
        const response = await fetch(uploadUrl, {
          method: "PUT",
          headers: {
            "Authorization": `Bearer ${accessToken}`,
            "Content-Type": "text/csv"
          },
          body: csvBlob
        });

        if (response.ok) {
          const result = await response.json();
          showUploadStatus(`âœ… CSV erfolgreich zu OneDrive hochgeladen: ${csvFileName}`, "success");
          console.log("CSVæ–‡ä»¶ä¸Šä¼ æˆåŠŸ:", result);
          
          // æ ‡è®°CSVä¸Šä¼ å®Œæˆ
          uploadStatus.csvUploaded = true;
          console.log("CSVä¸Šä¼ å®Œæˆï¼Œæ›´æ–°çŠ¶æ€");
          
          // æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ·æ–°é¡µé¢
          uploadStatus.checkAndRefresh();
          
          return true;
        } else {
          const errorText = await response.text();
          console.error("CSVä¸Šä¼ å¤±è´¥:", response.status, errorText);
          
          let errorMessage = "CSV-Upload fehlgeschlagen";
          if (response.status === 401) {
            errorMessage = "Berechtigung abgelaufen. Versuchen Sie erneut.";
          } else if (response.status === 403) {
            errorMessage = "Keine Berechtigung zum Hochladen. ÃœberprÃ¼fen Sie die OneDrive-Berechtigungen.";
          } else if (response.status >= 500) {
            errorMessage = "OneDrive-Server-Fehler. Versuchen Sie es spÃ¤ter erneut.";
          }
          
          throw new Error(`${errorMessage} (${response.status})`);
        }
      } catch (error) {
        console.error("CSV Upload error:", error);
        showUploadStatus(`âŒ CSV-Upload fehlgeschlagen: ${error.message}`, "error");
        return false;
      }
    }

    // ä¸Šä¼ æ–‡ä»¶åˆ°OneDrive
    async function uploadToOneDrive(fileBlob, fileName) {
      if (!account) {
        showUploadStatus("âŒ Bitte melden Sie sich zuerst bei OneDrive an!", "error");
        return false;
      }

      if (!msalInstance) {
        showUploadStatus("âŒ OneDrive-Service nicht verfÃ¼gbar. Versuchen Sie, die Seite neu zu laden.", "error");
        return false;
      }

      if (!fileBlob || !fileName) {
        showUploadStatus("âŒ UngÃ¼ltige Datei. Bitte generieren Sie zuerst ein PDF!", "error");
        return false;
      }

      try {
        showUploadStatus("â³ Berechtigung wird Ã¼berprÃ¼ft...", "");
        console.log(`å¼€å§‹ä¸Šä¼ æ–‡ä»¶: ${fileName}, å¤§å°: ${fileBlob.size} bytes`);
        
        const accessToken = await getFileAccessToken();
        
        showUploadStatus("â³ Lade PDF zu OneDrive hoch...", "");
        console.log("æ–‡ä»¶è®¿é—®æƒé™è·å–æˆåŠŸï¼Œå¼€å§‹ä¸Šä¼ ");
        
        // åˆ›å»ºæ–‡ä»¶å¤¹ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        const folderName = "Palettenscheine";
        await createOneDriveFolder(accessToken, folderName);
        
        // ä¸Šä¼ æ–‡ä»¶åˆ°æŒ‡å®šæ–‡ä»¶å¤¹
        const uploadUrl = `https://graph.microsoft.com/v1.0/me/drive/root:/${folderName}/${fileName}:/content`;
        
        console.log(`ä¸Šä¼ åˆ°: ${uploadUrl}`);
        
        const response = await fetch(uploadUrl, {
          method: "PUT",
          headers: {
            "Authorization": `Bearer ${accessToken}`,
            "Content-Type": "application/pdf"
          },
          body: fileBlob
        });

        if (response.ok) {
          const result = await response.json();
          const fileUrl = result.webUrl || `OneDrive/${folderName}/${fileName}`;
          showUploadStatus(`âœ… PDF erfolgreich zu OneDrive hochgeladen: ${fileName}`, "success");
          console.log("æ–‡ä»¶ä¸Šä¼ æˆåŠŸ:", result);
          
          // æ ‡è®°PDFä¸Šä¼ å®Œæˆ
          uploadStatus.pdfUploaded = true;
          console.log("PDFä¸Šä¼ å®Œæˆï¼Œæ›´æ–°çŠ¶æ€");
          
          // æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ·æ–°é¡µé¢
          uploadStatus.checkAndRefresh();
          
          return true;
        } else {
          const errorText = await response.text();
          console.error("ä¸Šä¼ å¤±è´¥:", response.status, errorText);
          
          let errorMessage = "Upload fehlgeschlagen";
          if (response.status === 401) {
            errorMessage = "Berechtigung abgelaufen. Versuchen Sie erneut.";
          } else if (response.status === 403) {
            errorMessage = "Keine Berechtigung zum Hochladen. ÃœberprÃ¼fen Sie die OneDrive-Berechtigungen.";
          } else if (response.status >= 500) {
            errorMessage = "OneDrive-Server-Fehler. Versuchen Sie es spÃ¤ter erneut.";
          }
          
          throw new Error(`${errorMessage} (${response.status})`);
        }
      } catch (error) {
        console.error("Upload error:", error);
        showUploadStatus(`âŒ Upload fehlgeschlagen: ${error.message}`, "error");
        return false;
      }
    }

    // åˆ›å»ºOneDriveæ–‡ä»¶å¤¹
    async function createOneDriveFolder(accessToken, folderName) {
      try {
        console.log(`Creating/checking folder: ${folderName}`);
        
        // é¦–å…ˆæ£€æŸ¥æ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨
        const checkResponse = await fetch(`https://graph.microsoft.com/v1.0/me/drive/root:/${folderName}`, {
          headers: {
            "Authorization": `Bearer ${accessToken}`
          }
        });

        if (checkResponse.ok) {
          console.log("Folder already exists");
          return;
        }

        // æ–‡ä»¶å¤¹ä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒ
        const createResponse = await fetch(`https://graph.microsoft.com/v1.0/me/drive/root/children`, {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${accessToken}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            name: folderName,
            folder: {},
            "@microsoft.graph.conflictBehavior": "ignore"
          })
        });
        
        if (createResponse.ok || createResponse.status === 409) {
          console.log("Folder created or already exists");
        } else {
          const errorText = await createResponse.text();
          console.warn("Could not create folder:", createResponse.status, errorText);
        }
      } catch (error) {
        console.warn("Could not create folder:", error);
      }
    }

    // æ˜¾ç¤ºä¸Šä¼ çŠ¶æ€
    function showUploadStatus(message, type) {
      const statusDiv = document.getElementById("upload-status");
      statusDiv.textContent = message;
      statusDiv.className = type;
      
      // 5ç§’åæ¸…é™¤æˆåŠŸæ¶ˆæ¯
      if (type === "success") {
        setTimeout(() => {
          statusDiv.textContent = "";
          statusDiv.className = "";
        }, 8000);
      }
    }


    // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
    function bindEventListeners() {
      console.log("ç»‘å®šOneDriveäº‹ä»¶ç›‘å¬å™¨...");
      
      const loginButton = document.getElementById("login-button");
      const logoutButton = document.getElementById("logout-button");
      const uploadButton = document.getElementById("upload-button");
      const uploadCSVButton = document.getElementById("upload-csv-button");
      
      if (loginButton) {
        loginButton.addEventListener("click", (e) => {
          e.preventDefault();
          loginToOneDrive();
        });
      }
      
      if (logoutButton) {
        logoutButton.addEventListener("click", (e) => {
          e.preventDefault();
          logoutFromOneDrive();
        });
      }
      
      if (uploadButton) {
        uploadButton.addEventListener("click", async (e) => {
          e.preventDefault();
          if (pdfBlob && filename) {
            // é‡ç½®ä¸Šä¼ çŠ¶æ€
            uploadStatus.reset();
            console.log("å¼€å§‹æ‰‹åŠ¨ä¸Šä¼ PDFï¼Œé‡ç½®ä¸Šä¼ çŠ¶æ€");
            await uploadToOneDrive(pdfBlob, filename);
          } else {
            showUploadStatus("âŒ Bitte generieren Sie zuerst ein PDF!", "error");
          }
        });
      }
      
      if (uploadCSVButton) {
        uploadCSVButton.addEventListener("click", async (e) => {
          e.preventDefault();
          // å¦‚æœè¿˜æ²¡å¼€å§‹ä¸Šä¼ æµç¨‹ï¼Œé‡ç½®çŠ¶æ€
          if (!uploadStatus.pdfUploaded && !uploadStatus.csvUploaded) {
            uploadStatus.reset();
            console.log("å¼€å§‹æ‰‹åŠ¨ä¸Šä¼ CSVï¼Œé‡ç½®ä¸Šä¼ çŠ¶æ€");
          }
          await uploadCSVToOneDrive();
        });
      }
    }

    // åœ¨é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      console.log("é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...");
      initializeMSAL();
    });
    
    // å¦‚æœDOMContentLoadedå·²ç»è§¦å‘ï¼Œç«‹å³åˆå§‹åŒ–
    if (document.readyState === 'loading') {
      // æ­£åœ¨åŠ è½½ä¸­ï¼Œç­‰å¾…DOMContentLoaded
    } else {
      // å·²ç»åŠ è½½å®Œæˆ
      console.log("é¡µé¢å·²åŠ è½½ï¼Œç«‹å³åˆå§‹åŒ–...");
      initializeMSAL();
    }

    // ------------------ DHL/GLS/Intern é€»è¾‘ ------------------
    function generateBerlinTimestamp() {
      const date = new Date();
      const options = { timeZone: "Europe/Berlin", year: "numeric", month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit" };
      const berlinTime = new Intl.DateTimeFormat("de-DE", options).format(date);
      const [d, m, y] = berlinTime.split(",")[0].split(".");
      const [h, min] = berlinTime.split(",")[1].trim().split(":");
      return `${y}${m}${d}-${h}${min}`;
    }

    function handleCompanyChange() {
      const company = document.getElementById("company").value;
      const nrField = document.getElementById("nr");
      const speditionField = document.getElementById("spedition");
      const timestamp = generateBerlinTimestamp();

      if (company === "GLS") {
        nrField.removeAttribute("readonly");
        nrField.value = "";
        speditionField.setAttribute("readonly", true);
        speditionField.value = "GLS";
      } else if (company === "DHL") {
        nrField.setAttribute("readonly", true);
        nrField.value = timestamp;
        speditionField.setAttribute("readonly", true);
        speditionField.value = "DHL";
      } else if (company === "Intern") {
        nrField.setAttribute("readonly", true);
        nrField.value = timestamp;
        speditionField.removeAttribute("readonly");
        speditionField.value = "";
      }

      const berlin = new Date(new Date().toLocaleString("en-US", { timeZone: "Europe/Berlin" }));
      const yyyy = berlin.getFullYear();
      const mm = String(berlin.getMonth() + 1).padStart(2, "0");
      const dd = String(berlin.getDate()).padStart(2, "0");
      document.getElementById("datum").value = `${yyyy}-${mm}-${dd}`;
    }

    // ------------------ ç­¾å ------------------
    function initCanvas(id) {
      const canvas = document.getElementById(id);
      const ctx = canvas.getContext("2d");
      canvas.width = canvas.offsetWidth;
      canvas.height = 150;
      let drawing = false;

      const getPos = (e) => {
        const rect = canvas.getBoundingClientRect();
        return { x: (e.clientX || e.touches[0].clientX) - rect.left, y: (e.clientY || e.touches[0].clientY) - rect.top };
      };

      canvas.addEventListener("mousedown", (e) => { drawing = true; ctx.beginPath(); ctx.moveTo(getPos(e).x, getPos(e).y); });
      canvas.addEventListener("mousemove", (e) => { if (drawing) { const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); } });
      canvas.addEventListener("mouseup", () => drawing = false);
      canvas.addEventListener("mouseout", () => drawing = false);
      canvas.addEventListener("touchstart", (e) => { e.preventDefault(); drawing = true; const p = getPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); });
      canvas.addEventListener("touchmove", (e) => { e.preventDefault(); if (drawing) { const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); } });
      canvas.addEventListener("touchend", () => drawing = false);
    }
    function getSignatureData(id) {
      return document.getElementById(id).toDataURL("image/png");
    }
    initCanvas("sign-fahrer");
    initCanvas("sign-dlog");
    handleCompanyChange();

    // ------------------ CSV ç¼“å­˜ ------------------
    let csvContent = "Nr,Datum,Spedition,Empfaenger,Lieferant,WA_WE,Europaletten,Einwegpaletten,Hinweis\n";

    // ------------------ ä¸Šä¼ çŠ¶æ€è·Ÿè¸ª ------------------
    let uploadStatus = {
      pdfUploaded: false,
      csvUploaded: false,
      isAutoUpload: false, // æ ‡è®°æ˜¯å¦ä¸ºè‡ªåŠ¨ä¸Šä¼ 
      reset: function() {
        this.pdfUploaded = false;
        this.csvUploaded = false;
        this.isAutoUpload = false;
      },
      checkAndRefresh: function() {
        console.log("æ£€æŸ¥ä¸Šä¼ çŠ¶æ€:", this);
        if (this.pdfUploaded && this.csvUploaded) {
          console.log("Both PDF and CSV files have been successfully uploaded. Ready to refresh the page....");
          showUploadStatus("âœ… All files have been uploaded! The page will automatically refresh in 3 seconds....", "success");
          
          // 3ç§’ååˆ·æ–°é¡µé¢
          setTimeout(() => {
            console.log("åˆ·æ–°é¡µé¢...");
            window.location.reload();
          }, 3000);
        }
      }
    };

    function convertToCSVRow(data) {
      return `${data.Nr},${data.Datum},${data.Spedition},${data.Empfaenger},${data.Lieferant},${data.WA_WE},${data.Europaletten},${data.Einwegpaletten},${data.Hinweis}\n`;
    }

    // ------------------ è¡¨å•æäº¤ ------------------
    let pdfBlob, filename;

    document.getElementById("main-form").addEventListener("submit", async (e) => {
      e.preventDefault();

      const data = {
        Nr: document.getElementById("nr").value,
        Datum: document.getElementById("datum").value,
        Spedition: document.getElementById("spedition").value,
        Empfaenger: document.getElementById("empfaenger").value,
        Lieferant: document.getElementById("lieferant").value,
        WA_WE: document.getElementById("wawe").value,
        Europaletten: document.getElementById("euro").value,
        Einwegpaletten: document.getElementById("einweg").value,
        Hinweis: document.getElementById("hinweis").value,
        SignFahrer: getSignatureData("sign-fahrer"),
        SignDlog: getSignatureData("sign-dlog")
      };

      // 1ï¸âƒ£ CSV ç´¯ç§¯
      csvContent += convertToCSVRow(data);

      // 2ï¸âƒ£ PDF ç”Ÿæˆ
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("Palettenschein", 105, 20, { align: "center" });
      let y = 30;
      for (const [k, v] of Object.entries(data)) {
        if (k !== "SignFahrer" && k !== "SignDlog") {
          doc.text(`${k}: ${v}`, 20, y);
          y += 10;
        }
      }
      doc.addImage(data.SignFahrer, "PNG", 20, y, 80, 40);
      doc.text("Unterschrift Fahrer", 20, y + 45);
      doc.addImage(data.SignDlog, "PNG", 110, y, 80, 40);
      doc.text("Unterschrift d-log", 110, y + 45);

      filename = `Palettenschein-${data.Nr}.pdf`;
      pdfBlob = doc.output("blob");

      document.getElementById("download-buttons").style.display = "block";
      
      // æ£€æŸ¥æ˜¯å¦éœ€è¦è‡ªåŠ¨ä¸Šä¼ åˆ°OneDrive
      const autoUploadCheckbox = document.getElementById("auto-upload-checkbox");
      if (autoUploadCheckbox && autoUploadCheckbox.checked && account) {
        // å»¶è¿Ÿ500msåè‡ªåŠ¨ä¸Šä¼ PDFå’ŒCSVï¼Œç»™ç”¨æˆ·çœ‹åˆ°PDFç”ŸæˆæˆåŠŸçš„åé¦ˆ
        setTimeout(async () => {
          try {
            // é‡ç½®ä¸Šä¼ çŠ¶æ€ï¼Œå¼€å§‹è‡ªåŠ¨ä¸Šä¼ æµç¨‹
            uploadStatus.reset();
            uploadStatus.isAutoUpload = true;
            console.log("å¼€å§‹è‡ªåŠ¨ä¸Šä¼ æµç¨‹ï¼Œé‡ç½®ä¸Šä¼ çŠ¶æ€");
            
            // å…ˆä¸Šä¼ PDF
            console.log("å¼€å§‹è‡ªåŠ¨ä¸Šä¼ PDF...");
            const pdfUploadSuccess = await uploadToOneDrive(pdfBlob, filename);
            
            // å¦‚æœPDFä¸Šä¼ æˆåŠŸï¼Œç­‰å¾…2ç§’åä¸Šä¼ CSV
            if (pdfUploadSuccess) {
              console.log("PDFä¸Šä¼ æˆåŠŸï¼Œç­‰å¾…2ç§’åä¸Šä¼ CSV...");
              await new Promise(resolve => setTimeout(resolve, 2000));
              console.log("å¼€å§‹è‡ªåŠ¨ä¸Šä¼ CSV...");
              await uploadCSVToOneDrive();
            }
          } catch (error) {
            console.error("è‡ªåŠ¨ä¸Šä¼ è¿‡ç¨‹ä¸­å‡ºé”™:", error);
            showUploadStatus(`âŒ è‡ªåŠ¨ä¸Šä¼ å¤±è´¥: ${error.message}`, "error");
          }
        }, 500);
      }
    });

    // PDF ä¸‹è½½
    document.getElementById("download-pdf").addEventListener("click", () => {
      const link = document.createElement("a");
      link.href = URL.createObjectURL(pdfBlob);
      link.download = filename;
      link.click();
    });

    // CSV ä¸‹è½½
    document.getElementById("download-csv").addEventListener("click", () => {
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      
      // ç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„å”¯ä¸€CSVæ–‡ä»¶åï¼Œä¸OneDriveä¸Šä¼ ä¿æŒä¸€è‡´
      const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
      link.download = `PalettenscheinData-${timestamp}.csv`;
      link.click();
    });
  </script>
</body>
</html>